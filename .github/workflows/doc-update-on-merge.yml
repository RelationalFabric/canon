name: Doc Update on Merge

on:
  pull_request:
    types:
      - closed
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-pr:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Generate branch name
        id: branch-name
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="doc/auto-update-$TIMESTAMP"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Created branch name: $BRANCH_NAME"

      - name: Create and checkout doc branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b ${{ steps.branch-name.outputs.branch }}

      - name: Generate examples documentation
        run: npm run build:docs:examples

      - name: Generate ADR Index
        run: npm run build:adr

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Files changed:"
            git status --porcelain
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git add -A
          git commit -m "docs: auto-update documentation after merge

          - Updated examples documentation
          - Updated ADR index
          - Generated automatically after merge into develop"
          git push origin ${{ steps.branch-name.outputs.branch }}

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'docs: auto-update documentation',
              head: '${{ steps.branch-name.outputs.branch }}',
              base: 'develop',
              body: `## Documentation Update

              This PR was automatically created after merging into \`develop\`.

              ### Changes
              - Updated examples documentation
              - Updated ADR index

              ### Generated by
              - Workflow: ${{ github.workflow }}
              - Triggered by: Merge of PR #${{ github.event.pull_request.number }}
              - Source branch: \`${{ github.event.pull_request.head.ref }}\`
              `
            });
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

      - name: Summary
        run: |
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "✅ Documentation updated successfully"
            echo "✅ Changes committed to branch: ${{ steps.branch-name.outputs.branch }}"
            echo "✅ Pull request created"
          else
            echo "ℹ️  No documentation changes detected"
            echo "ℹ️  Branch created but not pushed (no changes)"
            echo "ℹ️  Skipping PR creation"
          fi
