name: Version Bump - Main (Publish & Sync to Develop)

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  publish:
    outputs:
      version: ${{ steps.read-version.outputs.version }}
    runs-on: ubuntu-latest
    environment: npm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Read version from package.json
        id: read-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Publish to NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Output summary
        run: |
          echo "Published to NPM:"
          echo "  Version: ${{ steps.read-version.outputs.version }}"
          echo "  Package: @relational-fabric/canon"

  sync-to-develop:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      - name: Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Install dependencies
        run: npm ci

      - name: Sync version to develop
        id: sync-version
        run: |
          # Fetch all branches
          git fetch origin main develop
          
          # Checkout develop
          git checkout develop
          
          # Create sync branch
          MAIN_VERSION="${{ needs.publish.outputs.version }}"
          SYNC_BRANCH="sync/version-$MAIN_VERSION"
          git checkout -b "$SYNC_BRANCH"
          
          # Update package.json version if different
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          if [ "$CURRENT_VERSION" != "$MAIN_VERSION" ]; then
            npm pkg set version="$MAIN_VERSION"
            # Run npm install to ensure package-lock.json stays in sync
            npm install --package-lock-only
            git add package.json package-lock.json
            git commit -m "chore(release): sync version to $MAIN_VERSION from main"
            git push origin "$SYNC_BRANCH"
            echo "branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "Version already in sync, no changes needed"
          fi

      - name: Create PR to develop
        if: steps.sync-version.outputs.updated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SYNC_BRANCH: ${{ steps.sync-version.outputs.branch }}
          BASE_BRANCH: develop
          VERSION: ${{ needs.publish.outputs.version }}
        run: |
          echo "Checking if a PR from '$SYNC_BRANCH' to '$BASE_BRANCH' already exists..."
          EXISTING_PR_NUMBER=$(gh pr list \
            --head "$SYNC_BRANCH" \
            --base "$BASE_BRANCH" \
            --state open \
            --json number \
            -q '.[0].number' || echo "")

          if [ -n "$EXISTING_PR_NUMBER" ]; then
            echo "INFO: A pull request from '$SYNC_BRANCH' to '$BASE_BRANCH' (PR #$EXISTING_PR_NUMBER) already exists and is open. Skipping PR creation."
          else
            echo "Creating PR from '$SYNC_BRANCH' to '$BASE_BRANCH'..."
            gh pr create \
              --title "chore(release): sync version to $VERSION from main" \
              --body "This PR syncs the version number from main to develop after publishing to NPM.

          **Version Information:**
          - Version: $VERSION
          - Source: main branch
          - Status: Published to NPM

          This ensures develop branch is updated with the sealed version and any build artifacts." \
              --base "$BASE_BRANCH" \
              --head "$SYNC_BRANCH"
            echo "SUCCESS: Pull Request from '$SYNC_BRANCH' to '$BASE_BRANCH' created."
          fi
